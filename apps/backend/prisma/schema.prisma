generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Product {
  id                String             @id @default(cuid())
  name              String
  description       String
  priceCents        Int
  priceRange        PriceRange
  imageUrl          String?
  inStock           Boolean            @default(true)
  stockCount        Int                @default(0)
  occasions         Occasion[]
  seasons           Season[]
  moods             Mood[]
  colors            Color[]
  type              ProductType
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
  longDescription   String?
  isActive          Boolean            @default(true)
  categoryId        String?
  cartItems         CartItem[]
  orderItems        OrderItem[]
  category          Category?          @relation(fields: [categoryId], references: [id])
  subscriptionItems SubscriptionItem[]

  @@map("products")
}

model Category {
  id          String    @id @default(cuid())
  name        String    @unique
  description String?
  imageUrl    String?
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  products    Product[]

  @@map("categories")
}

model User {
  id                String         @id @default(cuid())
  email             String         @unique
  firstName         String?
  lastName          String?
  phone             String?
  role              UserRole       @default(CUSTOMER)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  favoriteOccasions Occasion[]
  favoriteColors    Color[]
  favoriteMoods     Mood[]
  addresses         Address[]
  carts             Cart[]
  orders            Order[]
  subscriptions     Subscription[]

  @@map("users")
}

model Address {
  id        String   @id @default(cuid())
  userId    String
  label     String?
  firstName String
  lastName  String
  company   String?
  street1   String
  street2   String?
  city      String
  state     String
  zipCode   String
  country   String   @default("US")
  phone     String?
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders    Order[]  @relation("ShippingAddress")

  @@map("addresses")
}

model Order {
  id                    String            @id @default(cuid())
  orderNumber           String            @unique
  userId                String?
  status                OrderStatus       @default(PENDING)
  subtotalCents         Int
  shippingCents         Int
  taxCents              Int
  discountCents         Int               @default(0)
  totalCents            Int
  deliveryType          DeliveryType
  requestedDeliveryDate DateTime?
  deliveryNotes         String?
  shippingAddressId     String?
  createdAt             DateTime          @default(now())
  updatedAt             DateTime          @updatedAt
  purchaseType          PurchaseType
  guestEmail            String?
  guestPhone            String?
  subscriptionId        String?
  subscriptionType      SubscriptionType?
  shippingFirstName     String
  shippingLastName      String
  shippingStreet1       String
  shippingStreet2       String?
  shippingCity          String
  shippingState         String
  shippingZipCode       String
  shippingCountry       String            @default("AU")
  shippingPhone         String?
  billingFirstName      String?
  billingLastName       String?
  billingStreet1        String?
  billingStreet2        String?
  billingCity           String?
  billingState          String?
  billingZipCode        String?
  billingCountry        String?           @default("AU")
  billingPhone          String?
  actualDeliveryDate    DateTime?
  deliveryDistanceKm    Float?
  deliveryLatitude      Float?
  deliveryLongitude     Float?
  deliveryTracking      DeliveryTracking?
  items                 OrderItem[]
  shippingAddress       Address?          @relation("ShippingAddress", fields: [shippingAddressId], references: [id])
  subscription          Subscription?     @relation(fields: [subscriptionId], references: [id])
  user                  User?             @relation(fields: [userId], references: [id])
  payments              Payment[]
  sendleQuote           SendleQuote?

  @@map("orders")
}

model OrderItem {
  id                    String            @id @default(cuid())
  orderId               String
  productId             String
  quantity              Int
  priceCents            Int
  subscriptionType      SubscriptionType?
  requestedDeliveryDate DateTime?
  order                 Order             @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product               Product           @relation(fields: [productId], references: [id])

  @@map("order_items")
}

model Subscription {
  id                    String                     @id @default(cuid())
  userId                String
  type                  SubscriptionType
  status                SubscriptionStatus         @default(ACTIVE)
  nextDeliveryDate      DateTime?
  lastDeliveryDate      DateTime?
  stripeSubscriptionId  String?                    @unique
  deliveryType          DeliveryType               @default(STANDARD)
  deliveryNotes         String?
  shippingFirstName     String
  shippingLastName      String
  shippingStreet1       String
  shippingStreet2       String?
  shippingCity          String
  shippingState         String
  shippingZipCode       String
  shippingCountry       String                     @default("AU")
  shippingPhone         String?
  createdAt             DateTime                   @default(now())
  updatedAt             DateTime                   @updatedAt
  failedPaymentCount    Int                        @default(0)
  lastBillingAttempt    DateTime?
  lastBillingError      String?
  nextRetryDate         DateTime?
  stripeCustomerId      String?
  stripePaymentMethodId String?
  orders                Order[]
  billingEvents         SubscriptionBillingEvent[]
  items                 SubscriptionItem[]
  user                  User                       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model SubscriptionItem {
  id             String       @id @default(cuid())
  subscriptionId String
  productId      String
  quantity       Int          @default(1)
  product        Product      @relation(fields: [productId], references: [id])
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@unique([subscriptionId, productId])
  @@map("subscription_items")
}

model SubscriptionBillingEvent {
  id                    String       @id @default(cuid())
  subscriptionId        String
  eventType             String
  amountCents           Int?
  skippedItems          Json?
  stripePaymentIntentId String?      @unique
  errorCode             String?
  errorMessage          String?
  orderId               String?
  createdAt             DateTime     @default(now())
  subscription          Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@map("subscription_billing_events")
}

model Payment {
  id                    String    @id @default(cuid())
  orderId               String
  amountCents           Int
  currency              String    @default("USD")
  stripePaymentIntentId String?   @unique
  stripePaymentMethodId String?
  status                String
  paidAt                DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  order                 Order     @relation(fields: [orderId], references: [id])

  @@map("payments")
}

model EmailTemplate {
  id          String   @id @default(cuid())
  name        String   @unique
  subject     String
  htmlContent String
  textContent String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("email_templates")
}

model EmailLog {
  id           String    @id @default(cuid())
  toEmail      String
  subject      String
  templateName String?
  status       String
  orderId      String?
  userId       String?
  sentAt       DateTime?
  errorMessage String?
  createdAt    DateTime  @default(now())

  @@map("email_logs")
}

model DeliveryZone {
  id                    String           @id @default(cuid())
  name                  String           @unique
  description           String?
  zipCodes              String[]
  cities                String[]
  standardCostCents     Int
  expressCostCents      Int?
  sameDayCostCents      Int?
  standardDeliveryDays  Int              @default(5)
  expressDeliveryDays   Int              @default(2)
  sameDayAvailable      Boolean          @default(false)
  sameDayCutoffHour     Int?
  freeDeliveryThreshold Int?
  weekendDelivery       Boolean          @default(false)
  holidayDelivery       Boolean          @default(false)
  isActive              Boolean          @default(true)
  createdAt             DateTime         @default(now())
  updatedAt             DateTime         @updatedAt
  centerLatitude        Float?
  centerLongitude       Float?
  radiusKm              Float?           @default(50)
  deliveryWindows       DeliveryWindow[]

  @@map("delivery_zones")
}

model DeliveryWindow {
  id                  String       @id @default(cuid())
  zoneId              String
  name                String
  startTime           String
  endTime             String
  additionalCostCents Int          @default(0)
  isAvailable         Boolean      @default(true)
  zone                DeliveryZone @relation(fields: [zoneId], references: [id], onDelete: Cascade)

  @@map("delivery_windows")
}

model DeliveryMethod {
  id                String       @id @default(cuid())
  name              String       @unique
  description       String
  deliveryType      DeliveryType
  baseCostCents     Int
  isActive          Boolean      @default(true)
  estimatedDays     Int
  trackingAvailable Boolean      @default(true)
  signatureRequired Boolean      @default(false)
  insuranceIncluded Boolean      @default(false)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt

  @@map("delivery_methods")
}

model DeliveryTracking {
  id                           String          @id @default(cuid())
  orderId                      String          @unique
  trackingNumber               String?         @unique
  carrierName                  String?
  status                       String          @default("PREPARING")
  currentLocation              String?
  estimatedDelivery            DateTime?
  actualDelivery               DateTime?
  deliveredTo                  String?
  deliveryNotes                String?
  deliveryPhoto                String?
  createdAt                    DateTime        @default(now())
  updatedAt                    DateTime        @updatedAt
  distanceKm                   Float?
  googleDistanceMatrixResponse Json?
  lastWebhookReceivedAt        DateTime?
  sendleOrderId                String?         @unique
  sendleQuoteId                String?
  sendleTrackingUrl            String?
  sendleWebhookEvents          Json[]          @default([])
  order                        Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  events                       TrackingEvent[]

  @@map("delivery_tracking")
}

model TrackingEvent {
  id                String           @id @default(cuid())
  trackingId        String
  timestamp         DateTime
  location          String?
  status            String
  description       String
  isCustomerVisible Boolean          @default(true)
  createdAt         DateTime         @default(now())
  tracking          DeliveryTracking @relation(fields: [trackingId], references: [id], onDelete: Cascade)

  @@map("tracking_events")
}

model Cart {
  id        String     @id @default(cuid())
  userId    String?
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  items     CartItem[]
  user      User?      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("carts")
}

model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  productId String
  quantity  Int      @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  product   Product  @relation(fields: [productId], references: [id])

  @@map("cart_items")
}

model SendleQuote {
  id               String   @id @default(cuid())
  orderId          String?  @unique
  quoteId          String   @unique
  priceCents       Int
  etaDays          Int
  pickupSuburb     String
  deliverySuburb   String
  deliveryPostcode String
  weightKg         Float    @default(1.0)
  volumeCm3        Float?
  expiresAt        DateTime
  isSelected       Boolean  @default(false)
  createdAt        DateTime @default(now())
  order            Order?   @relation(fields: [orderId], references: [id])

  @@index([orderId])
  @@index([expiresAt])
  @@map("sendle_quotes")
}

model WebhookLog {
  id           String    @id @default(cuid())
  provider     String
  eventType    String
  payload      Json
  status       String
  errorMessage String?
  orderId      String?
  trackingId   String?
  createdAt    DateTime  @default(now())
  processedAt  DateTime?

  @@index([provider, eventType])
  @@index([createdAt])
  @@map("webhook_logs")
}

enum PurchaseType {
  ONE_TIME
  SUBSCRIPTION
}

enum SubscriptionType {
  RECURRING_WEEKLY
  RECURRING_BIWEEKLY
  RECURRING_MONTHLY
  RECURRING_QUARTERLY
  RECURRING_YEARLY
  SPONTANEOUS
  SPONTANEOUS_WEEKLY
  SPONTANEOUS_BIWEEKLY
  SPONTANEOUS_MONTHLY
}

enum SubscriptionStatus {
  ACTIVE
  PAUSED
  CANCELLED
  EXPIRED
  PAYMENT_FAILED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PREPARING
  OUT_FOR_DELIVERY
  DELIVERED
  CANCELLED
  REFUNDED
}

enum Occasion {
  BIRTHDAY
  ANNIVERSARY
  WEDDING
  GRADUATION
  VALENTINES_DAY
  MOTHERS_DAY
  FATHERS_DAY
  CHRISTMAS
  EASTER
  SYMPATHY
  CONGRATULATIONS
  GET_WELL_SOON
  JUST_BECAUSE
  HOUSEWARMING
  THANK_YOU
}

enum Season {
  SPRING
  SUMMER
  FALL
  WINTER
  ALL_SEASON
}

enum Mood {
  ROMANTIC
  CHEERFUL
  ELEGANT
  PEACEFUL
  VIBRANT
  SOPHISTICATED
  WHIMSICAL
  CLASSIC
  MODERN
  RUSTIC
}

enum Color {
  RED
  PINK
  WHITE
  YELLOW
  ORANGE
  PURPLE
  BLUE
  GREEN
  MIXED
  PASTEL
  BURGUNDY
  LAVENDER
}

enum ProductType {
  BOUQUET
  ARRANGEMENT
  PLANT
  SUCCULENT
  ORCHID
  ROSE
  LILY
  TULIP
  SUNFLOWER
  MIXED_FLOWERS
  DRIED_FLOWERS
  ARTIFICIAL
}

enum PriceRange {
  UNDER_25
  RANGE_25_50
  RANGE_50_75
  RANGE_75_100
  OVER_100
}

enum DeliveryType {
  STANDARD
  EXPRESS
  SAME_DAY
  PICKUP
}

enum UserRole {
  CUSTOMER
  ADMIN
}
